---

- name: Registry | Delegate tasks
  when:
    - inventory_hostname == groups['kube-setup-delegate'][0]
  block:
  - name: Registry | Create subfolder
    file:
      path: "{{ role_dir }}"
      state: directory
      mode: '0755'

#---- Generate harbor key
  - name: Setup | Stat for key file
    stat:
      path: "{{ role_dir }}/harbor_key"
    register: stat_result

  - name: Setup | Check for key file or create
    when: stat_result is defined and not stat_result.stat.exists
    block: 
    - name: Setup | Generate key
      set_fact: 
        harbor_key: "{{ (99999999 | random | to_uuid)[0:16] }}"
        cacheable: no

    - name: Setup | Write key to file
      copy: 
        content: "{{ harbor_key }}"
        dest: "{{ role_dir }}/harbor_key"

  - name: Setup | Get key file contents 
    when: stat_result is defined and stat_result.stat.exists
    block:
    - name: Setup | Slurp file
      slurp: 
        src: "{{ role_dir }}/harbor_key"
      register: slurp_contents

    - name: Setup | Reuse key
      set_fact:
        harbor_key: "{{ slurp_contents.content | b64decode }}"

#---- Generate harbor pass
  - name: Setup | Stat for pass file
    stat:
      path: "{{ role_dir }}/harbor_pass"
    register: stat_result

  - name: Setup | Check for pass file or create
    when: stat_result is defined and not stat_result.stat.exists
    block: 
    - name: Setup | Generate pass
      set_fact: 
        harbor_pass: "{{ (99999999 | random | to_uuid)[0:5] }}"
        cacheable: no

    - name: Setup | Write pass to file
      copy: 
        content: "{{ harbor_pass }}"
        dest: "{{ role_dir }}/harbor_pass"

  - name: Setup | Get pass file contents 
    when: stat_result is defined and stat_result.stat.exists
    block:
    - name: Setup | Slurp file
      slurp: 
        src: "{{ role_dir }}/harbor_pass"
      register: slurp_contents

    - name: Setup | Reuse pass
      set_fact:
        harbor_pass: "{{ slurp_contents['content'] | b64decode }}"

#---- Template out the manifests
  - name: Registry | Templates list
    set_fact:
      registry_role_templates:
        - { name: namespace, file: registry-namespace.yml, type: ns }

  - name: Registry | Template values file
    template:
      src: "registry-values.yml"
      dest: "{{ role_dir }}/registry-values.yml"

  - name: Registry | Create manifests
    template:
      src: "{{ item.file }}"
      dest: "{{ role_dir }}/{{ item.file }}"
    with_items: "{{ registry_role_templates }}"
    register: registry_role_manifests
    when:
      - inventory_hostname == groups['kube-master'][0]

  # Namespace must be deployed before secret.
  - name: Registry | Apply manifests
    kube:
      name: "{{ item.item.name }}"
      namespace: "{{ registry_namespace }}"
      kubectl: "{{ bin_dir }}/kubectl"
      resource: "{{ item.item.type }}"
      filename: "{{ role_dir }}/{{ item.item.file }}"
      state: "latest"
    with_items: "{{ registry_role_manifests.results }}"

  # We need to give each node the CA so docker/kubernetes trusts the registry
  - name: Registry | Copy CA from remote
    fetch:
      src: "{{ ca_path_remote_src }}"
      dest: "ca.pem"
      flat: yes

#---- Copy CA cert to each node

- name: Certificates | Make dest dir
  file:
    dest: "{{ ca_path_dest }}"
    state: directory
    mode: "0755"

- name: Registry | Copy CA to each node
  copy:
    src: "ca.pem"
    dest: "{{ ca_path_dest }}/ca.crt"

- name: Registry | Delegate tasks
  when:
    - inventory_hostname == groups['kube-setup-delegate'][0]
  block:
  #---- Create secret
  - name: Registry | Check for secret
    shell: "{{ bin_dir }}/kubectl get secrets -n {{ registry_namespace }}"
    register: registry_secret_exists
    changed_when: false

  - name: Registry | Create secret
    shell: "{{ bin_dir }}/kubectl create secret generic {{ ingress_secretName }} --from-file {{ ingress_tls_cert }} --from-file {{ ingress_tls_key }} -n {{ registry_namespace }}"
    when: "ingress_secretName not in registry_secret_exists.stdout"

  #---- Deploy chart and templates
  - name: Registry | Add repo
    shell: "{{ bin_dir }}/helm repo add harbor https://helm.goharbor.io"

  - name: Registry | Deploy harbor chart
    helm_chart:
      name: "{{ helm_registry_name }}"
      namespace: "{{ registry_namespace }}"
      bin_dir: "{{ bin_dir }}"
      chart_src: harbor/harbor
      chart_version: 1.2.0
      path_to_values: "{{ role_dir }}/registry-values.yml"

  - name: Registry | Wait for registry to rollout
    shell: "{{ bin_dir }}/kubectl -n {{ registry_namespace }} rollout status deploy/{{ platform_prefix }}-registry-harbor-registry"

# This way nodes can pull from the the private-registry without needing an image pull secret.
- name: Registry | Docker login on each nodes
  shell: "docker login \
  --username={{ harbor_user }} \
  --password={{ hostvars[groups['kube-setup-delegate'][0]]['harbor_pass'] }} \
  'https://{{ ingress_host }}'"
  no_log: true    # Prevent the credentials from showing in the logs